<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Alpine Pulse">
<meta name="theme-color" content="#0B1120">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>Alpine Pulse</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,700&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#0B1120;--card:#111827;--border:#1e293b;
    --t1:#f1f5f9;--t2:#c8d0db;--t3:#64748b;
    --blue:#38bdf8;--green:#34d399;--amber:#fbbf24;--red:#f87171;--purple:#a78bfa;
    --pos:#34d399;--neu:#94a3b8;--neg:#f87171;
    --fortress:#38bdf8;--castle:#a78bfa;--nakiska:#fbbf24;
    --grandecache:#fb923c;--davidthompson:#2dd4bf;
    --safe-top:env(safe-area-inset-top);
    --safe-bottom:env(safe-area-inset-bottom);
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--t1);min-height:100vh;
    -webkit-overflow-scrolling:touch;padding-bottom:var(--safe-bottom)}
  body::before{content:'';position:fixed;inset:0;
    background:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events:none;z-index:9999}

  .header{display:flex;align-items:center;justify-content:space-between;
    padding:12px 16px;padding-top:calc(12px + var(--safe-top));
    border-bottom:1px solid var(--border);
    background:linear-gradient(180deg,rgba(56,189,248,0.04) 0%,transparent 100%);
    position:sticky;top:0;z-index:100;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)}
  .logo{display:flex;align-items:center;gap:10px}
  .logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--fortress),var(--castle));
    border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:18px;
    box-shadow:0 0 16px rgba(56,189,248,0.2)}
  .logo h1{font-family:'Playfair Display',serif;font-size:18px;font-weight:800;
    background:linear-gradient(135deg,#f1f5f9,#94a3b8);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .header-right{display:flex;align-items:center;gap:10px}
  .status-pill{padding:4px 10px;border-radius:16px;font-size:11px;font-weight:500;
    display:flex;align-items:center;gap:5px}
  .status-live{background:rgba(52,211,153,0.12);color:var(--pos);border:1px solid rgba(52,211,153,0.2)}
  .status-demo{background:rgba(251,191,36,0.12);color:var(--amber);border:1px solid rgba(251,191,36,0.2)}
  .live-dot{width:6px;height:6px;border-radius:50%;background:currentColor;animation:pulse 2s infinite}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}

  .main{padding:16px;max-width:700px;margin:0 auto}

  /* Tabs - scrollable for 6 locations */
  .tabs{display:flex;gap:6px;margin-bottom:16px;overflow-x:auto;-webkit-overflow-scrolling:touch;
    scrollbar-width:none;padding-bottom:2px}
  .tabs::-webkit-scrollbar{display:none}
  .tab{padding:7px 12px;border-radius:8px;font-size:11px;font-weight:500;cursor:pointer;
    border:1px solid var(--border);background:transparent;color:var(--t2);transition:all 0.2s;
    white-space:nowrap;flex-shrink:0;-webkit-tap-highlight-color:transparent}
  .tab.active{color:var(--t1)}
  .tab.active[data-r="all"]{background:rgba(255,255,255,0.1);border-color:rgba(255,255,255,0.2)}
  .tab.active[data-r="fortress"]{background:rgba(56,189,248,0.15);border-color:rgba(56,189,248,0.3);color:var(--fortress)}
  .tab.active[data-r="castle"]{background:rgba(167,139,250,0.15);border-color:rgba(167,139,250,0.3);color:var(--castle)}
  .tab.active[data-r="nakiska"]{background:rgba(251,191,36,0.15);border-color:rgba(251,191,36,0.3);color:var(--nakiska)}
  .tab.active[data-r="grandecache"]{background:rgba(251,146,60,0.15);border-color:rgba(251,146,60,0.3);color:var(--grandecache)}
  .tab.active[data-r="davidthompson"]{background:rgba(45,212,191,0.15);border-color:rgba(45,212,191,0.3);color:var(--davidthompson)}

  /* Summary cards */
  .summary-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
  .s-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px 16px;
    position:relative;overflow:hidden}
  .s-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
  .s-card:nth-child(1)::before{background:var(--blue)}
  .s-card:nth-child(2)::before{background:var(--pos)}
  .s-card:nth-child(3)::before{background:var(--neg)}
  .s-card:nth-child(4)::before{background:var(--purple)}
  .s-label{font-size:10px;text-transform:uppercase;letter-spacing:1.2px;color:var(--t3);margin-bottom:4px}
  .s-value{font-family:'Playfair Display',serif;font-size:26px;font-weight:800}
  .s-sub{font-size:11px;color:var(--t3);margin-top:2px}

  /* Sentiment row */
  .sent-row{display:flex;gap:10px;margin-bottom:16px}
  .sent-block{flex:1;text-align:center;padding:14px 8px;border-radius:10px;
    background:var(--card);border:1px solid var(--border)}
  .sent-pct{font-family:'Playfair Display',serif;font-size:28px;font-weight:800;line-height:1}
  .sent-pct.pos{color:var(--pos)}.sent-pct.neu{color:var(--neu)}.sent-pct.neg{color:var(--neg)}
  .sent-label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--t3);margin-top:4px}
  .bar-row{height:8px;border-radius:4px;background:var(--bg);display:flex;overflow:hidden;gap:2px;margin-bottom:16px}
  .bar-pos{background:var(--pos);border-radius:4px 0 0 4px;transition:width 0.6s}
  .bar-neu{background:var(--neu);transition:width 0.6s}
  .bar-neg{background:var(--neg);border-radius:0 4px 4px 0;transition:width 0.6s}

  /* Sections */
  .section{background:var(--card);border:1px solid var(--border);border-radius:12px;
    padding:16px;margin-bottom:16px}
  .section-title{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:1px;
    color:var(--t2);margin-bottom:14px;display:flex;justify-content:space-between;align-items:center}
  .section-sub{font-size:10px;color:var(--t3);font-weight:400;text-transform:none;letter-spacing:0}

  /* Resort bars */
  .resort-bar{margin-bottom:12px}
  .resort-bar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px}
  .resort-name{font-size:12px;font-weight:600}
  .resort-count{font-size:10px;color:var(--t3)}

  /* Themes */
  .theme-item{display:flex;align-items:center;justify-content:space-between;
    padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.04)}
  .theme-item:last-child{border-bottom:none}
  .theme-left{flex:1}
  .theme-name{font-size:13px;font-weight:500;color:var(--t1)}
  .theme-mentions{font-size:11px;color:var(--t3)}
  .badge{display:inline-block;padding:3px 8px;border-radius:10px;font-size:10px;font-weight:600}
  .badge-pos{background:rgba(52,211,153,0.15);color:var(--pos)}
  .badge-neu{background:rgba(148,163,184,0.15);color:var(--neu)}
  .badge-neg{background:rgba(248,113,113,0.15);color:var(--neg)}

  /* Chart */
  .chart-wrap{height:180px;margin:8px 0}
  .chart-wrap svg{width:100%;height:100%}
  .chart-grid{stroke:var(--border);stroke-width:1;stroke-dasharray:4,4}
  .chart-line{fill:none;stroke-width:2.5;stroke-linecap:round;stroke-linejoin:round}
  .chart-area{opacity:0.08}
  .chart-lbl{fill:var(--t3);font-size:9px;font-family:'DM Sans',sans-serif}
  .legend{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:8px}
  .legend-item{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--t2)}
  .legend-dot{width:7px;height:7px;border-radius:50%}

  /* Feed ‚Äî updated text color for readability */
  .feed-item{display:flex;gap:10px;padding:12px;border-radius:10px;
    background:rgba(255,255,255,0.02);border:1px solid var(--border);margin-bottom:8px;
    -webkit-tap-highlight-color:transparent;cursor:pointer;transition:background 0.2s}
  .feed-item:hover,.feed-item:active{background:rgba(255,255,255,0.05)}
  a.feed-link{text-decoration:none;color:inherit;display:flex;gap:10px;width:100%}
  .feed-bar{width:3px;border-radius:2px;flex-shrink:0;align-self:stretch;min-height:36px}
  .feed-bar.positive{background:var(--pos)}.feed-bar.neutral{background:var(--neu)}.feed-bar.negative{background:var(--neg)}
  .feed-body{flex:1;min-width:0}
  .feed-source{font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--t3);
    display:flex;align-items:center;gap:6px;margin-bottom:3px;flex-wrap:wrap}
  .feed-tag{padding:1px 5px;border-radius:3px;font-size:8px;font-weight:600}
  .tag-fortress{background:rgba(56,189,248,0.15);color:var(--fortress)}
  .tag-castle{background:rgba(167,139,250,0.15);color:var(--castle)}
  .tag-nakiska{background:rgba(251,191,36,0.15);color:var(--nakiska)}
  .tag-grandecache{background:rgba(251,146,60,0.15);color:var(--grandecache)}
  .tag-davidthompson{background:rgba(45,212,191,0.15);color:var(--davidthompson)}
  .tag-gov{background:rgba(248,113,113,0.12);color:#fca5a5}
  /* CHANGED: feed text is now light gray/white instead of blue */
  .feed-text{font-size:13px;color:#e2e8f0;line-height:1.5;
    display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
  .feed-meta{font-size:10px;color:var(--t3);margin-top:4px}
  .feed-date{font-size:9px;color:var(--t3);margin-left:auto}

  /* Today's articles button */
  .today-btn{width:100%;padding:12px 16px;border-radius:10px;border:1px solid rgba(56,189,248,0.3);
    background:rgba(56,189,248,0.08);color:var(--blue);font-size:13px;font-weight:600;
    cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;
    margin-bottom:16px;font-family:'DM Sans',sans-serif;transition:all 0.2s;
    -webkit-tap-highlight-color:transparent}
  .today-btn:hover,.today-btn:active{background:rgba(56,189,248,0.15)}
  .today-btn .count{background:var(--blue);color:var(--bg);padding:2px 8px;border-radius:10px;font-size:11px}

  /* Modal overlay for today's articles */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:200;
    display:none;align-items:flex-end;justify-content:center;
    backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}
  .modal-overlay.show{display:flex}
  .modal{background:var(--card);border:1px solid var(--border);border-radius:20px 20px 0 0;
    width:100%;max-width:700px;max-height:85vh;overflow-y:auto;padding:20px 16px;
    padding-bottom:calc(20px + var(--safe-bottom));
    animation:slideUp 0.3s ease;-webkit-overflow-scrolling:touch}
  @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
  .modal-handle{width:40px;height:4px;border-radius:2px;background:var(--border);margin:0 auto 16px}
  .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
  .modal-title{font-size:16px;font-weight:700;color:var(--t1)}
  .modal-close{background:rgba(255,255,255,0.1);border:none;color:var(--t2);width:32px;height:32px;
    border-radius:50%;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center}

  /* Gov Alberta section */
  .gov-section{background:linear-gradient(135deg,rgba(248,113,113,0.05),rgba(251,191,36,0.05));
    border:1px solid rgba(248,113,113,0.2);border-radius:12px;padding:16px;margin-bottom:16px}
  .gov-header{display:flex;align-items:center;gap:8px;margin-bottom:14px}
  .gov-icon{font-size:16px}
  .gov-title{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:#fca5a5}
  .gov-item{padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.04)}
  .gov-item:last-child{border-bottom:none}
  .gov-item-title{font-size:13px;font-weight:500;color:var(--t1);margin-bottom:3px}
  .gov-item-detail{font-size:12px;color:#e2e8f0;line-height:1.5}
  .gov-item-meta{font-size:10px;color:var(--t3);margin-top:4px;display:flex;gap:8px}
  .gov-badge{display:inline-block;padding:2px 7px;border-radius:8px;font-size:9px;font-weight:600;
    background:rgba(248,113,113,0.12);color:#fca5a5;margin-left:6px}

  /* Action items */
  .action{display:flex;align-items:flex-start;gap:10px;padding:12px;border-radius:10px;
    border:1px solid var(--border);background:rgba(255,255,255,0.02);margin-bottom:8px}
  .action-dot{width:8px;height:8px;border-radius:50%;margin-top:4px;flex-shrink:0}
  .dot-high{background:var(--neg);box-shadow:0 0 8px rgba(248,113,113,0.4)}
  .dot-med{background:var(--amber);box-shadow:0 0 8px rgba(251,191,36,0.3)}
  .dot-low{background:var(--pos);box-shadow:0 0 8px rgba(52,211,153,0.3)}
  .action-text{font-size:13px;color:#e2e8f0;line-height:1.45}
  .action-text strong{color:var(--t1)}

  /* Bottom nav */
  .bottom-nav{position:fixed;bottom:0;left:0;right:0;
    background:rgba(17,24,39,0.95);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
    border-top:1px solid var(--border);display:flex;
    padding:8px 0;padding-bottom:calc(8px + var(--safe-bottom));z-index:100}
  .nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;
    color:var(--t3);font-size:9px;text-transform:uppercase;letter-spacing:0.5px;
    cursor:pointer;-webkit-tap-highlight-color:transparent;padding:4px 0;transition:color 0.2s}
  .nav-item.active{color:var(--blue)}
  .nav-icon{font-size:18px}
  .nav-label{font-weight:500}

  .view{display:none}.view.active{display:block}
  @keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  .anim{animation:fadeUp 0.4s ease forwards;opacity:0}
  .d1{animation-delay:.03s}.d2{animation-delay:.06s}.d3{animation-delay:.09s}
  .d4{animation-delay:.12s}.d5{animation-delay:.15s}.d6{animation-delay:.18s}
  .nav-spacer{height:calc(70px + var(--safe-bottom))}

  .empty-state{text-align:center;padding:40px 20px;color:var(--t3);font-size:13px}
</style>
</head>
<body>

<header class="header">
  <div class="logo"><div class="logo-icon">‚õ∞</div><h1>Alpine Pulse</h1></div>
  <div class="header-right">
    <div class="status-pill status-demo" id="statusPill">
      <span class="live-dot"></span><span id="statusText">Demo</span>
    </div>
  </div>
</header>

<!-- Today's Articles Modal -->
<div class="modal-overlay" id="todayModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <span class="modal-title">üì∞ Today's Articles</span>
      <button class="modal-close" id="closeModal">‚úï</button>
    </div>
    <div id="todayArticles"></div>
  </div>
</div>

<main class="main">
  <!-- Overview -->
  <div class="view active" id="viewOverview">
    <div class="tabs" id="mainTabs"></div>
    <button class="today-btn" id="todayBtn">üì∞ View Today's Articles <span class="count" id="todayCount">0</span></button>
    <div id="summaryCards"></div>
    <div id="sentimentSection"></div>
    <div id="resortBreakdown"></div>
    <div id="sentimentTrend"></div>
  </div>

  <!-- Themes -->
  <div class="view" id="viewThemes">
    <div id="themeList" class="section anim"></div>
    <div id="govSection"></div>
    <div id="themeTrend" class="section anim"></div>
  </div>

  <!-- Feed -->
  <div class="view" id="viewFeed">
    <div class="tabs" id="feedTabs"></div>
    <div id="feedItems"></div>
  </div>

  <!-- Actions -->
  <div class="view" id="viewActions">
    <div id="actionItems"></div>
  </div>

  <div class="nav-spacer"></div>
</main>

<nav class="bottom-nav">
  <div class="nav-item active" data-view="viewOverview"><div class="nav-icon">üìä</div><div class="nav-label">Overview</div></div>
  <div class="nav-item" data-view="viewThemes"><div class="nav-icon">üè∑</div><div class="nav-label">Themes</div></div>
  <div class="nav-item" data-view="viewFeed"><div class="nav-icon">üì°</div><div class="nav-label">Feed</div></div>
  <div class="nav-item" data-view="viewActions"><div class="nav-icon">‚ö°</div><div class="nav-label">Actions</div></div>
</nav>

<script>
// =====================================================================
// ALPINE PULSE v2 ‚Äî Updated Dashboard
// Changes: 5 locations, 7-day feed, readable text, today's articles,
// location-specific filtering, weekly sentiment, Gov Alberta section
// =====================================================================

const DATA_URL = './data/dashboard.json';
let data = null;
let currentResort = 'all';

// Location config
const LOCATIONS = {
  fortress:      { name:'Fortress Mountain',  color:'var(--fortress)',      tagClass:'tag-fortress' },
  castle:        { name:'Castle Mountain',     color:'var(--castle)',        tagClass:'tag-castle' },
  nakiska:       { name:'Nakiska',             color:'var(--nakiska)',       tagClass:'tag-nakiska' },
  grandecache:   { name:'Grande Cache',        color:'var(--grandecache)',   tagClass:'tag-grandecache' },
  davidthompson: { name:'David Thompson',      color:'var(--davidthompson)', tagClass:'tag-davidthompson' },
};

// ---- DEMO DATA ----
const today = new Date().toISOString().split('T')[0];
function daysAgo(n){ const d=new Date(); d.setDate(d.getDate()-n); return d.toISOString(); }

const DEMO = {
  generated_at: new Date().toISOString(), date: today,
  summary: { total_mentions:412, positive_pct:59, neutral_pct:28, negative_pct:13, negative_count:54 },
  resort_stats: {
    fortress:      { name:'Fortress Mountain',  total:118, positive_pct:58, neutral_pct:28, negative_pct:14 },
    castle:        { name:'Castle Mountain',     total:96,  positive_pct:70, neutral_pct:22, negative_pct:8 },
    nakiska:       { name:'Nakiska',             total:74,  positive_pct:55, neutral_pct:32, negative_pct:13 },
    grandecache:   { name:'Grande Cache',        total:68,  positive_pct:62, neutral_pct:25, negative_pct:13 },
    davidthompson: { name:'David Thompson Region', total:56, positive_pct:52, neutral_pct:30, negative_pct:18 },
  },
  themes: [
    { name:'Snow Conditions',       mentions:89, avg_score:72, sentiment:'positive' },
    { name:'Pricing & Value',       mentions:64, avg_score:48, sentiment:'neutral' },
    { name:'Summer Activities',     mentions:58, avg_score:78, sentiment:'positive' },
    { name:'Staff & Service',       mentions:41, avg_score:81, sentiment:'positive' },
    { name:'Lift Wait Times',       mentions:38, avg_score:28, sentiment:'negative' },
    { name:'Trails & Recreation',   mentions:35, avg_score:71, sentiment:'positive' },
    { name:'Facilities & Lodging',  mentions:31, avg_score:52, sentiment:'neutral' },
    { name:'Access & Transportation', mentions:24, avg_score:38, sentiment:'negative' },
    { name:'Environmental Impact',  mentions:18, avg_score:45, sentiment:'neutral' },
  ],
  gov_alberta: [
    { title:'Tourism Levy Reinvestment Program update', detail:'Ministry of Tourism and Sport announced revised guidelines for the Tourism Levy Reinvestment Program affecting all-season resort operators. New application window opens March 2026.', theme:'Tourism Strategy & Policy', date:daysAgo(0), sentiment:'neutral' },
    { title:'Clearwater County land use bylaw amendment', detail:'Clearwater County council voted to amend land use bylaws in the David Thompson corridor to allow expanded commercial recreation uses in designated tourism nodes.', theme:'Regulatory Approvals', date:daysAgo(1), sentiment:'positive' },
    { title:'Environmental assessment for Fortress expansion', detail:'Alberta Environment and Protected Areas requires updated environmental impact assessment for proposed Fortress Mountain summer operations expansion into adjacent crown land.', theme:'Environmental Assessment', date:daysAgo(2), sentiment:'neutral' },
    { title:'Alberta Tourism Strategy 2026-2030 draft released', detail:'Government of Alberta released draft tourism strategy emphasizing all-season resort development as a priority sector. Public consultation period open until April 15.', theme:'Tourism Strategy & Policy', date:daysAgo(3), sentiment:'positive' },
    { title:'Grande Cache trail system regulatory review', detail:'Alberta Parks reviewing trail designation and commercial use permits for Grande Cache area recreation corridors. Stakeholder input deadline extended to March 31.', theme:'Regulatory Approvals', date:daysAgo(5), sentiment:'neutral' },
  ],
  trends: {
    labels:['Mon','Tue','Wed','Thu','Fri','Sat','Sun'],
    positive:[57,59,61,63,60,62,59],
    neutral:[29,28,26,25,27,26,28],
    negative:[14,13,13,12,13,12,13]
  },
  theme_trends: {
    'Snow Conditions':   [30,32,28,34,29,35,38],
    'Summer Activities': [14,15,16,18,17,19,20],
    'Trails & Recreation':[8,9,10,11,10,12,12],
    'Staff & Service':   [12,11,13,12,14,12,13],
  },
  feed: [
    // Today
    { source:'X (Twitter)',   resort:'fortress',    sentiment:'positive', text:'Incredible powder day at Fortress! Fresh 25cm overnight and the alpine bowls are absolutely pristine. Best conditions this season.',                          engagement:'47 likes',    theme:'Snow Conditions',       date:daysAgo(0) },
    { source:'CBC News',      resort:'castle',      sentiment:'neutral',  text:'All Season Resorts Alberta announces expanded summer programming at Castle Mountain, including mountain biking trails and guided nature walks launching June 2026.', engagement:'News',        theme:'Summer Activities',     date:daysAgo(0) },
    { source:'Facebook',      resort:'nakiska',     sentiment:'positive', text:'Took the kids to Nakiska for their first ski lesson. Instructors were patient and amazing. Really well-organized family program!',                               engagement:'28 reactions', theme:'Staff & Service',       date:daysAgo(0) },
    { source:'Reddit',        resort:'grandecache', sentiment:'positive', text:'Hiked the Grande Cache Flats trail last weekend. The trail system up there is seriously underrated ‚Äî great shape and well marked for winter use.',                 engagement:'34 upvotes',  theme:'Trails & Recreation',   date:daysAgo(0) },
    { source:'Calgary Herald',resort:'davidthompson',sentiment:'neutral', text:'Clearwater County tourism committee reviewing proposals for expanded trail networks in the David Thompson corridor and Saunders tourism node.',                    engagement:'News',        theme:'Access & Transportation',date:daysAgo(0) },
    { source:'Gov Alberta',   resort:'fortress',    sentiment:'neutral',  text:'Alberta Environment and Protected Areas requires updated environmental impact assessment for proposed Fortress Mountain summer operations expansion.',             engagement:'Gov release', theme:'Environmental Impact',  date:daysAgo(0) },
    // Day 1
    { source:'Reddit',        resort:'castle',      sentiment:'positive', text:'Castle Mountain is an underrated gem. No crowds, amazing terrain variety, and the new lodge upgrades are noticeable. Great value for a season pass.',              engagement:'89 upvotes',  theme:'Pricing & Value',       date:daysAgo(1) },
    { source:'Google Reviews', resort:'nakiska',    sentiment:'negative', text:'Waited 35 minutes for the Olympic Chair on a Saturday. For a resort this close to Calgary, they need more lift capacity during peak weekends.',                   engagement:'3 stars',     theme:'Lift Wait Times',       date:daysAgo(1) },
    { source:'Instagram',     resort:'fortress',    sentiment:'positive', text:'The backcountry access at Fortress is next level. Nothing else like it in Alberta. Already planning summer hiking trips too.',                                     engagement:'234 likes',   theme:'Summer Activities',     date:daysAgo(1) },
    { source:'TripAdvisor',   resort:'grandecache', sentiment:'positive', text:'Grande Cache is a hidden treasure for outdoor recreation. Excellent trail conditions and the mountain views are spectacular in every season.',                      engagement:'5 stars',     theme:'Trails & Recreation',   date:daysAgo(1) },
    // Day 2
    { source:'X (Twitter)',   resort:'fortress',    sentiment:'negative', text:'Road to Fortress needs serious attention. Hit 3 potholes on the access road. Love the skiing but the drive in is rough.',                                          engagement:'23 likes',    theme:'Access & Transportation',date:daysAgo(2) },
    { source:'TripAdvisor',   resort:'castle',      sentiment:'positive', text:'Best ski experience in southern Alberta. New grooming equipment has made a huge difference on intermediate runs. Highly recommend.',                                engagement:'5 stars',     theme:'Snow Conditions',       date:daysAgo(2) },
    { source:'Reddit',        resort:'davidthompson',sentiment:'positive',text:'The White Goat wilderness area is incredible for backcountry. Nordegg and the David Thompson corridor deserve way more attention as a tourism destination.',         engagement:'56 upvotes',  theme:'Trails & Recreation',   date:daysAgo(2) },
    // Day 3
    { source:'Reddit',        resort:'nakiska',     sentiment:'neutral',  text:'Anyone know if Nakiska is planning to expand their summer operations? Would love to see mountain biking like what Castle is doing.',                               engagement:'12 comments', theme:'Summer Activities',      date:daysAgo(3) },
    { source:'Calgary Herald',resort:'fortress',    sentiment:'positive', text:'Alberta all-season resort strategy showing results as Fortress Mountain reports 18% visitor increase year-over-year for winter season.',                            engagement:'News',        theme:'Pricing & Value',       date:daysAgo(3) },
    { source:'Facebook',      resort:'grandecache', sentiment:'negative', text:'Grande Cache needs better signage for recreational trails. Got completely lost on what should have been a simple loop. Frustrating experience.',                     engagement:'15 reactions', theme:'Trails & Recreation',   date:daysAgo(3) },
    // Day 4-6
    { source:'Google Reviews', resort:'castle',     sentiment:'negative', text:'Food options at the lodge are limited and overpriced. A burger and fries for $24 is too much. Would love to see more affordable options.',                          engagement:'2 stars',     theme:'Facilities & Lodging',  date:daysAgo(4) },
    { source:'Instagram',     resort:'nakiska',     sentiment:'positive', text:'Night skiing at Nakiska hits different. Great vibes, well-lit runs, and proximity to Calgary makes it perfect for after-work sessions.',                            engagement:'156 likes',   theme:'Summer Activities',     date:daysAgo(4) },
    { source:'X (Twitter)',   resort:'davidthompson',sentiment:'neutral', text:'Saunders tourism node development in the David Thompson region is starting to take shape. Interesting to see what comes of the new recreation master plan.',        engagement:'18 likes',    theme:'Access & Transportation',date:daysAgo(5) },
    { source:'Reddit',        resort:'grandecache', sentiment:'positive', text:'Grande Cache mountain trail running community is growing fast. The area has real potential for organized trail running events and races.',                           engagement:'42 upvotes',  theme:'Trails & Recreation',   date:daysAgo(6) },
    { source:'Gov Alberta',   resort:'castle',      sentiment:'neutral',  text:'Government of Alberta Tourism and Sport ministry confirms Castle Mountain Resort included in priority investment corridor for all-season development.',             engagement:'Gov release', theme:'Summer Activities',     date:daysAgo(6) },
  ]
};

// ---- LOAD DATA ----
async function loadData(){
  try {
    const r = await fetch(DATA_URL);
    if(!r.ok) throw new Error();
    data = await r.json();
    document.getElementById('statusPill').className = 'status-pill status-live';
    document.getElementById('statusText').textContent = 'Live';
  } catch(e) {
    data = DEMO;
    document.getElementById('statusPill').className = 'status-pill status-demo';
    document.getElementById('statusText').textContent = 'Demo';
  }
  renderAll();
}

// ---- NAVIGATION ----
document.querySelectorAll('.nav-item').forEach(item => {
  item.addEventListener('click', () => {
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    item.classList.add('active');
    document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
    document.getElementById(item.dataset.view).classList.add('active');
    window.scrollTo(0, 0);
  });
});

// ---- TODAY'S ARTICLES MODAL ----
document.getElementById('todayBtn').addEventListener('click', () => {
  document.getElementById('todayModal').classList.add('show');
  renderTodayArticles();
});
document.getElementById('closeModal').addEventListener('click', () => {
  document.getElementById('todayModal').classList.remove('show');
});
document.getElementById('todayModal').addEventListener('click', (e) => {
  if(e.target === e.currentTarget) e.currentTarget.classList.remove('show');
});

// ---- HELPERS ----
function getFiltered(){
  if(currentResort === 'all') return data.feed;
  return data.feed.filter(f => f.resort === currentResort);
}

function isToday(dateStr){
  if(!dateStr) return false;
  return dateStr.substring(0,10) === today;
}

function isLast7Days(dateStr){
  if(!dateStr) return true; // show if no date
  const d = new Date(dateStr);
  const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - 7);
  return d >= cutoff;
}

function dayLabel(dateStr){
  if(!dateStr) return '';
  const d = new Date(dateStr);
  const now = new Date();
  const diff = Math.floor((now - d) / 86400000);
  if(diff === 0) return 'Today';
  if(diff === 1) return 'Yesterday';
  return d.toLocaleDateString('en-CA', { weekday:'short', month:'short', day:'numeric' });
}

function getSentimentForResort(resort){
  if(resort === 'all') return data.summary;
  const rs = data.resort_stats[resort];
  if(!rs) return data.summary;
  return {
    total_mentions: rs.total,
    positive_pct: rs.positive_pct,
    neutral_pct: rs.neutral_pct,
    negative_pct: rs.negative_pct,
    negative_count: Math.round(rs.total * rs.negative_pct / 100)
  };
}

// ---- TABS ----
function buildTabs(containerId){
  const el = document.getElementById(containerId);
  let html = '<button class="tab active" data-r="all">All</button>';
  for(const[k,v] of Object.entries(LOCATIONS)){
    html += `<button class="tab" data-r="${k}">‚¨• ${v.name}</button>`;
  }
  el.innerHTML = html;
  el.querySelectorAll('.tab').forEach(t => {
    t.addEventListener('click', () => {
      // Sync all tab bars
      document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
      document.querySelectorAll(`.tab[data-r="${t.dataset.r}"]`).forEach(b => b.classList.add('active'));
      currentResort = t.dataset.r;
      // Re-render filtered views
      renderSummary(); renderSentiment(); renderResorts(); renderFeed(); updateTodayCount();
    });
  });
}

// ---- RENDER ALL ----
function renderAll(){
  buildTabs('mainTabs');
  buildTabs('feedTabs');
  renderSummary(); renderSentiment(); renderResorts();
  renderSentimentTrend(); renderThemes(); renderGovSection();
  renderThemeTrend(); renderFeed(); renderActions(); updateTodayCount();
}

// ---- SUMMARY CARDS ----
function renderSummary(){
  const s = getSentimentForResort(currentResort);
  const label = currentResort === 'all' ? 'All Locations' : LOCATIONS[currentResort]?.name || '';
  const topTheme = data.themes[0]?.name || '‚Äî';
  document.getElementById('summaryCards').innerHTML = `
    <div class="summary-grid">
      <div class="s-card anim d1"><div class="s-label">Mentions</div><div class="s-value">${s.total_mentions}</div><div class="s-sub">${label}</div></div>
      <div class="s-card anim d2"><div class="s-label">Positive</div><div class="s-value" style="color:var(--pos)">${s.positive_pct}%</div><div class="s-sub">Sentiment</div></div>
      <div class="s-card anim d3"><div class="s-label">Negative</div><div class="s-value" style="color:var(--neg)">${s.negative_count}</div><div class="s-sub">Need attention</div></div>
      <div class="s-card anim d4"><div class="s-label">Top Theme</div><div class="s-value" style="font-size:15px;margin-top:4px">${topTheme}</div><div class="s-sub">${data.themes[0]?.mentions||0} mentions</div></div>
    </div>`;
}

// ---- SENTIMENT ----
function renderSentiment(){
  const s = getSentimentForResort(currentResort);
  document.getElementById('sentimentSection').innerHTML = `
    <div class="sent-row anim d3">
      <div class="sent-block"><div class="sent-pct pos">${s.positive_pct}%</div><div class="sent-label">Positive</div></div>
      <div class="sent-block"><div class="sent-pct neu">${s.neutral_pct}%</div><div class="sent-label">Neutral</div></div>
      <div class="sent-block"><div class="sent-pct neg">${s.negative_pct}%</div><div class="sent-label">Negative</div></div>
    </div>
    <div class="bar-row anim d4">
      <div class="bar-pos" style="width:${s.positive_pct}%"></div>
      <div class="bar-neu" style="width:${s.neutral_pct}%"></div>
      <div class="bar-neg" style="width:${s.negative_pct}%"></div>
    </div>`;
}

// ---- RESORT BREAKDOWN (only show when "All" selected) ----
function renderResorts(){
  if(currentResort !== 'all'){
    document.getElementById('resortBreakdown').innerHTML = '';
    return;
  }
  let html = '<div class="section anim d5"><div class="section-title">Location Breakdown</div>';
  for(const[rk,rs] of Object.entries(data.resort_stats)){
    const color = LOCATIONS[rk]?.color || 'var(--t2)';
    html += `<div class="resort-bar">
      <div class="resort-bar-header">
        <span class="resort-name" style="color:${color}">${rs.name}</span>
        <span class="resort-count">${rs.total} mentions</span>
      </div>
      <div class="bar-row"><div class="bar-pos" style="width:${rs.positive_pct}%"></div>
        <div class="bar-neu" style="width:${rs.neutral_pct}%"></div>
        <div class="bar-neg" style="width:${rs.negative_pct}%"></div></div>
    </div>`;
  }
  html += '</div>';
  document.getElementById('resortBreakdown').innerHTML = html;
}

// ---- SENTIMENT TREND (last week) ----
function renderSentimentTrend(){
  document.getElementById('sentimentTrend').innerHTML = `
    <div class="section anim d6">
      <div class="section-title">Sentiment Trend <span class="section-sub">Last 7 days</span></div>
      <div class="chart-wrap"><svg id="sentChartM" viewBox="0 0 600 180" preserveAspectRatio="none"></svg></div>
      <div class="legend">
        <div class="legend-item"><div class="legend-dot" style="background:var(--pos)"></div>Positive</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--neu)"></div>Neutral</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--neg)"></div>Negative</div>
      </div>
    </div>`;
  setTimeout(() => {
    drawChart('sentChartM', [
      { data:data.trends.positive, color:'#34d399' },
      { data:data.trends.neutral,  color:'#94a3b8' },
      { data:data.trends.negative, color:'#f87171' }
    ], data.trends.labels);
  }, 100);
}

// ---- THEMES ----
function renderThemes(){
  let html = '<div class="section-title">Theme Rankings <span class="section-sub">by sentiment</span></div>';
  data.themes.forEach(t => {
    const bc = t.sentiment==='positive'?'badge-pos':t.sentiment==='negative'?'badge-neg':'badge-neu';
    html += `<div class="theme-item">
      <div class="theme-left"><div class="theme-name">${t.name}</div><div class="theme-mentions">${t.mentions} mentions ¬∑ score ${t.avg_score}</div></div>
      <span class="badge ${bc}">${t.sentiment}</span></div>`;
  });
  document.getElementById('themeList').innerHTML = html;
}

// ---- GOVERNMENT OF ALBERTA SECTION ----
function renderGovSection(){
  const items = data.gov_alberta || [];
  if(!items.length){
    document.getElementById('govSection').innerHTML = '';
    return;
  }
  let html = `<div class="gov-section anim">
    <div class="gov-header"><span class="gov-icon">üèõ</span><span class="gov-title">Government of Alberta ‚Äî Tourism & Sport</span></div>`;
  items.forEach(item => {
    const bc = item.sentiment==='positive'?'badge-pos':item.sentiment==='negative'?'badge-neg':'badge-neu';
    html += `<div class="gov-item">
      <div class="gov-item-title">${item.title} <span class="gov-badge">${item.theme}</span></div>
      <div class="gov-item-detail">${item.detail}</div>
      <div class="gov-item-meta"><span>${dayLabel(item.date)}</span><span class="badge ${bc}" style="font-size:9px">${item.sentiment}</span></div>
    </div>`;
  });
  html += '</div>';
  document.getElementById('govSection').innerHTML = html;
}

// ---- THEME TREND ----
function renderThemeTrend(){
  const keys = Object.keys(data.theme_trends || {}).slice(0,4);
  const colors = ['#38bdf8','#a78bfa','#fbbf24','#34d399'];
  const datasets = keys.map((k,i) => ({ data:data.theme_trends[k], color:colors[i] }));
  const legendHtml = keys.map((k,i) => `<div class="legend-item"><div class="legend-dot" style="background:${colors[i]}"></div>${k}</div>`).join('');
  document.getElementById('themeTrend').innerHTML = `
    <div class="section-title">Theme Trends <span class="section-sub">Last 7 days</span></div>
    <div class="chart-wrap"><svg id="themeChartM" viewBox="0 0 600 180" preserveAspectRatio="none"></svg></div>
    <div class="legend">${legendHtml}</div>`;
  setTimeout(() => {
    if(datasets.length) drawChart('themeChartM', datasets, data.trends.labels);
  }, 150);
}

// ---- FEED (last 7 days, filtered by location) ----
function renderFeed(){
  const filtered = getFiltered().filter(f => isLast7Days(f.date));
  if(!filtered.length){
    document.getElementById('feedItems').innerHTML = '<div class="empty-state">No mentions in the last 7 days for this location.</div>';
    return;
  }
  document.getElementById('feedItems').innerHTML = filtered.map(f => {
    const hasUrl = f.url && f.url.startsWith('http');
    const openTag = hasUrl ? `<a class="feed-link" href="${f.url}" target="_blank" rel="noopener">` : `<div class="feed-link">`;
    const closeTag = hasUrl ? `</a>` : `</div>`;
    return `<div class="feed-item" data-resort="${f.resort}">
      ${openTag}
      <div class="feed-bar ${f.sentiment}"></div>
      <div class="feed-body">
        <div class="feed-source">${f.source}
          <span class="feed-tag ${LOCATIONS[f.resort]?.tagClass || 'tag-fortress'}">${(LOCATIONS[f.resort]?.name || f.resort).toUpperCase()}</span>
          ${f.theme ? `<span style="color:var(--t3);font-size:8px">&middot; ${f.theme}</span>` : ''}
          <span class="feed-date">${dayLabel(f.date)}</span>
        </div>
        <div class="feed-text">${f.text}</div>
        <div class="feed-meta">${f.engagement || ''}${hasUrl ? ' <span style="color:var(--t3);font-size:9px">&#x2197; Open</span>' : ''}</div>
      </div>
      ${closeTag}
    </div>`;
  }).join('');
}

// ---- TODAY'S ARTICLES ----
function updateTodayCount(){
  const todayItems = getFiltered().filter(f => isToday(f.date));
  document.getElementById('todayCount').textContent = todayItems.length;
}

function renderTodayArticles(){
  const todayItems = getFiltered().filter(f => isToday(f.date));
  if(!todayItems.length){
    document.getElementById('todayArticles').innerHTML = '<div class="empty-state">No new articles today yet.</div>';
    return;
  }
  document.getElementById('todayArticles').innerHTML = todayItems.map(f => {
    const hasUrl = f.url && f.url.startsWith('http');
    const openTag = hasUrl ? `<a class="feed-link" href="${f.url}" target="_blank" rel="noopener">` : `<div class="feed-link">`;
    const closeTag = hasUrl ? `</a>` : `</div>`;
    return `<div class="feed-item">
      ${openTag}
      <div class="feed-bar ${f.sentiment}"></div>
      <div class="feed-body">
        <div class="feed-source">${f.source}
          <span class="feed-tag ${LOCATIONS[f.resort]?.tagClass || ''}">${(LOCATIONS[f.resort]?.name || f.resort).toUpperCase()}</span>
          ${f.theme ? `<span style="color:var(--t3);font-size:8px">&middot; ${f.theme}</span>` : ''}
        </div>
        <div class="feed-text" style="-webkit-line-clamp:unset">${f.text}</div>
        <div class="feed-meta">${f.engagement || ''}${hasUrl ? ' <span style="color:var(--t3);font-size:9px">&#x2197; Open</span>' : ''}</div>
      </div>
      ${closeTag}
    </div>`;
  }).join('');
}

// ---- ACTIONS ----
function renderActions(){
  const neg = data.themes.filter(t => t.sentiment==='negative');
  const neu = data.themes.filter(t => t.sentiment==='neutral').slice(0,2);
  const pos = data.themes.filter(t => t.sentiment==='positive').slice(0,1);
  let html = '<div class="section anim"><div class="section-title">Action Items <span class="section-sub">prioritized</span></div></div>';
  neg.forEach(t => {
    html += `<div class="action"><div class="action-dot dot-high"></div><div class="action-text"><strong>${t.name}</strong> ‚Äî ${t.mentions} mentions with negative sentiment (score: ${t.avg_score}/100). Review and consider response strategy.</div></div>`;
  });

  // Gov Alberta actions
  const govItems = (data.gov_alberta || []).filter(g => g.sentiment !== 'positive');
  govItems.slice(0,2).forEach(g => {
    html += `<div class="action"><div class="action-dot dot-med"></div><div class="action-text"><strong>üèõ ${g.title}</strong> ‚Äî ${g.detail.substring(0,120)}... <em style="color:var(--t3)">(${g.theme})</em></div></div>`;
  });

  neu.forEach(t => {
    html += `<div class="action"><div class="action-dot dot-med"></div><div class="action-text"><strong>${t.name}</strong> ‚Äî ${t.mentions} neutral mentions. Monitor for sentiment shifts.</div></div>`;
  });
  pos.forEach(t => {
    html += `<div class="action"><div class="action-dot dot-low"></div><div class="action-text"><strong>${t.name}</strong> ‚Äî Strong positive (${t.avg_score}/100). Amplify and share with team.</div></div>`;
  });
  document.getElementById('actionItems').innerHTML = html;
}

// ---- CHART ----
function drawChart(id, datasets, labels){
  const svg = document.getElementById(id);
  if(!svg || !datasets.length) return;
  const W=600, H=180, p={t:8,r:16,b:24,l:30};
  const cW=W-p.l-p.r, cH=H-p.t-p.b;
  const allV = datasets.flatMap(d => d.data);
  const mx = Math.max(...allV, 10);
  let h = '';
  for(let i=0;i<=3;i++){
    const y=p.t+(cH/3)*i; const v=Math.round(mx-(mx/3)*i);
    h += `<line x1="${p.l}" y1="${y}" x2="${W-p.r}" y2="${y}" class="chart-grid"/>`;
    h += `<text x="${p.l-6}" y="${y+3}" text-anchor="end" class="chart-lbl">${v}</text>`;
  }
  labels.forEach((l,i)=>{
    if(l){ const x=p.l+(cW/(labels.length-1))*i; h+=`<text x="${x}" y="${H-4}" text-anchor="middle" class="chart-lbl">${l}</text>`; }
  });
  datasets.forEach(ds => {
    const pts = ds.data.map((v,i) => `${p.l+(cW/(ds.data.length-1))*i},${p.t+cH-(v/mx)*cH}`);
    h += `<polygon points="${pts.join(' ')} ${p.l+cW},${p.t+cH} ${p.l},${p.t+cH}" fill="${ds.color}" class="chart-area"/>`;
    h += `<polyline points="${pts.join(' ')}" class="chart-line" stroke="${ds.color}"/>`;
    const lp = pts[pts.length-1].split(',');
    h += `<circle cx="${lp[0]}" cy="${lp[1]}" r="3.5" fill="${ds.color}" stroke="var(--card)" stroke-width="2"/>`;
  });
  svg.innerHTML = h;
}

// ---- PWA ----
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('./sw.js').catch(()=>{});
}

// Auto-refresh every 30 min
setInterval(loadData, 30*60*1000);

// Init
loadData();
</script>
</body>
</html>
