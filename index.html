<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Alpine Pulse â€” All Season Resorts Alberta Monitor</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,700&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-primary: #0B1120;
    --bg-card: #111827;
    --bg-card-hover: #1a2234;
    --border: #1e293b;
    --text-primary: #f1f5f9;
    --text-secondary: #94a3b8;
    --text-muted: #64748b;
    --accent-blue: #38bdf8;
    --positive: #34d399;
    --neutral: #94a3b8;
    --negative: #f87171;
    --fortress: #38bdf8;
    --castle: #a78bfa;
    --nakiska: #fbbf24;
    --radius: 12px;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family:'DM Sans',sans-serif;
    background:var(--bg-primary);
    color:var(--text-primary);
    min-height:100vh;
  }
  body::before {
    content:'';position:fixed;inset:0;
    background:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events:none;z-index:9999;
  }
  .app-header {
    display:flex;align-items:center;justify-content:space-between;
    padding:20px 32px;border-bottom:1px solid var(--border);
    background:linear-gradient(180deg,rgba(56,189,248,0.04) 0%,transparent 100%);
    position:sticky;top:0;z-index:100;backdrop-filter:blur(20px);
  }
  .logo-area { display:flex;align-items:center;gap:16px; }
  .logo-icon {
    width:42px;height:42px;
    background:linear-gradient(135deg,var(--fortress),var(--castle));
    border-radius:10px;display:flex;align-items:center;justify-content:center;
    font-size:20px;box-shadow:0 0 20px rgba(56,189,248,0.2);
  }
  .logo-text h1 {
    font-family:'Playfair Display',serif;font-size:22px;font-weight:800;letter-spacing:-0.5px;
    background:linear-gradient(135deg,#f1f5f9,#94a3b8);-webkit-background-clip:text;-webkit-text-fill-color:transparent;
  }
  .logo-text span { font-size:11px;color:var(--text-muted);letter-spacing:2px;text-transform:uppercase; }
  .header-meta { display:flex;align-items:center;gap:20px; }
  .header-badge {
    padding:6px 14px;background:rgba(56,189,248,0.1);border:1px solid rgba(56,189,248,0.2);
    border-radius:20px;font-size:12px;color:var(--accent-blue);font-weight:500;
  }
  .live-dot {
    width:8px;height:8px;border-radius:50%;background:var(--positive);
    display:inline-block;margin-right:6px;animation:pulse 2s infinite;
  }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
  .date-display { font-size:13px;color:var(--text-secondary); }
  .main-content { max-width:1440px;margin:0 auto;padding:28px 32px; }
  .data-status {
    padding:12px 20px;border-radius:10px;margin-bottom:20px;font-size:13px;
    display:flex;align-items:center;gap:10px;
  }
  .status-live { background:rgba(52,211,153,0.1);border:1px solid rgba(52,211,153,0.2);color:var(--positive); }
  .status-demo { background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.2);color:var(--nakiska); }
  .summary-bar { display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:28px; }
  .summary-card {
    background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);
    padding:20px 24px;position:relative;overflow:hidden;transition:transform 0.2s,border-color 0.2s;
  }
  .summary-card:hover { transform:translateY(-2px);border-color:rgba(56,189,248,0.3); }
  .summary-card::after { content:'';position:absolute;top:0;left:0;right:0;height:2px; }
  .summary-card:nth-child(1)::after { background:var(--fortress); }
  .summary-card:nth-child(2)::after { background:var(--positive); }
  .summary-card:nth-child(3)::after { background:var(--negative); }
  .summary-card:nth-child(4)::after { background:var(--castle); }
  .summary-label { font-size:11px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-muted);margin-bottom:8px; }
  .summary-value { font-family:'Playfair Display',serif;font-size:32px;font-weight:800; }
  .summary-change { font-size:12px;margin-top:4px;display:flex;align-items:center;gap:4px; }
  .change-up { color:var(--positive); }
  .change-down { color:var(--negative); }
  .resort-tabs { display:flex;gap:8px;margin-bottom:20px; }
  .resort-tab {
    padding:8px 18px;border-radius:8px;font-size:13px;font-weight:500;cursor:pointer;
    border:1px solid var(--border);background:transparent;color:var(--text-secondary);transition:all 0.2s;
  }
  .resort-tab:hover { background:rgba(255,255,255,0.05); }
  .resort-tab.active { color:var(--text-primary); }
  .resort-tab.active[data-resort="all"] { background:rgba(255,255,255,0.1);border-color:rgba(255,255,255,0.2); }
  .resort-tab.active[data-resort="fortress"] { background:rgba(56,189,248,0.15);border-color:rgba(56,189,248,0.3);color:var(--fortress); }
  .resort-tab.active[data-resort="castle"] { background:rgba(167,139,250,0.15);border-color:rgba(167,139,250,0.3);color:var(--castle); }
  .resort-tab.active[data-resort="nakiska"] { background:rgba(251,191,36,0.15);border-color:rgba(251,191,36,0.3);color:var(--nakiska); }
  .dashboard-grid { display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:28px; }
  .card { background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:24px;transition:border-color 0.2s; }
  .card:hover { border-color:rgba(56,189,248,0.2); }
  .card-full { grid-column:1/-1; }
  .card-header { display:flex;justify-content:space-between;align-items:center;margin-bottom:20px; }
  .card-title { font-size:14px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-secondary); }
  .card-subtitle { font-size:11px;color:var(--text-muted); }
  .sentiment-overview { display:grid;grid-template-columns:repeat(3,1fr);gap:16px; }
  .sentiment-block { text-align:center;padding:16px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid var(--border); }
  .sentiment-pct { font-family:'Playfair Display',serif;font-size:36px;font-weight:800;line-height:1; }
  .sentiment-pct.pos { color:var(--positive); }
  .sentiment-pct.neu { color:var(--neutral); }
  .sentiment-pct.neg { color:var(--negative); }
  .sentiment-label { font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-top:6px; }
  .sentiment-bar-container { height:8px;border-radius:4px;background:var(--bg-primary);display:flex;overflow:hidden;gap:2px; }
  .sentiment-bar-pos { background:var(--positive);border-radius:4px 0 0 4px;transition:width 0.8s; }
  .sentiment-bar-neu { background:var(--neutral);transition:width 0.8s; }
  .sentiment-bar-neg { background:var(--negative);border-radius:0 4px 4px 0;transition:width 0.8s; }
  .theme-table { width:100%;border-collapse:separate;border-spacing:0 4px; }
  .theme-table th { text-align:left;font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-muted);padding:8px 12px;border-bottom:1px solid var(--border); }
  .theme-table td { padding:10px 12px;font-size:13px;color:var(--text-secondary);background:rgba(255,255,255,0.015); }
  .theme-table tr:hover td { background:rgba(255,255,255,0.04); }
  .theme-table td:first-child { border-radius:6px 0 0 6px;font-weight:500;color:var(--text-primary); }
  .theme-table td:last-child { border-radius:0 6px 6px 0; }
  .badge { display:inline-block;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:600; }
  .badge-pos { background:rgba(52,211,153,0.15);color:var(--positive); }
  .badge-neu { background:rgba(148,163,184,0.15);color:var(--neutral); }
  .badge-neg { background:rgba(248,113,113,0.15);color:var(--negative); }
  .mini-bar-chart { display:flex;align-items:flex-end;gap:2px;height:28px; }
  .mini-bar { width:6px;border-radius:2px; }
  .feed-list { display:flex;flex-direction:column;gap:8px;max-height:500px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--border) transparent; }
  .feed-item { display:flex;gap:12px;padding:14px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid var(--border);transition:background 0.2s;align-items:flex-start;cursor:pointer; }
  .feed-item:hover { background:rgba(255,255,255,0.04); }
  .feed-sentiment { width:4px;min-height:40px;border-radius:2px;flex-shrink:0;align-self:stretch; }
  .feed-sentiment.positive { background:var(--positive); }
  .feed-sentiment.neutral { background:var(--neutral); }
  .feed-sentiment.negative { background:var(--negative); }
  .feed-body { flex:1; }
  .feed-source { font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:4px;display:flex;align-items:center;gap:8px; }
  .feed-resort-tag { padding:1px 6px;border-radius:4px;font-size:9px;font-weight:600; }
  .tag-fortress { background:rgba(56,189,248,0.15);color:var(--fortress); }
  .tag-castle { background:rgba(167,139,250,0.15);color:var(--castle); }
  .tag-nakiska { background:rgba(251,191,36,0.15);color:var(--nakiska); }
  .feed-text { font-size:13px;color:var(--text-secondary);line-height:1.5; }
  .feed-meta { font-size:11px;color:var(--text-muted);margin-top:6px;display:flex;gap:12px; }
  .chart-container { position:relative;height:220px;margin-top:12px; }
  .chart-svg { width:100%;height:100%; }
  .chart-grid-line { stroke:var(--border);stroke-width:1;stroke-dasharray:4,4; }
  .chart-line { fill:none;stroke-width:2.5;stroke-linecap:round;stroke-linejoin:round; }
  .chart-area { opacity:0.1; }
  .chart-label { fill:var(--text-muted);font-size:10px;font-family:'DM Sans',sans-serif; }
  .chart-legend { display:flex;gap:20px;justify-content:center;margin-top:12px; }
  .legend-item { display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-secondary); }
  .legend-dot { width:8px;height:8px;border-radius:50%; }
  .action-list { display:flex;flex-direction:column;gap:10px; }
  .action-item { display:flex;align-items:flex-start;gap:12px;padding:14px;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,0.02); }
  .action-priority { width:8px;height:8px;border-radius:50%;margin-top:5px;flex-shrink:0; }
  .priority-high { background:var(--negative);box-shadow:0 0 8px rgba(248,113,113,0.4); }
  .priority-med { background:var(--nakiska);box-shadow:0 0 8px rgba(251,191,36,0.3); }
  .priority-low { background:var(--positive);box-shadow:0 0 8px rgba(52,211,153,0.3); }
  .action-text { font-size:13px;color:var(--text-secondary);line-height:1.5; }
  .action-text strong { color:var(--text-primary); }
  .resort-breakdown { margin-top:20px; }
  .resort-row { margin-bottom:12px; }
  .resort-row-header { display:flex;justify-content:space-between;align-items:center;margin-bottom:6px; }
  .resort-row-name { font-size:12px;font-weight:600; }
  .resort-row-count { font-size:11px;color:var(--text-muted); }
  @keyframes fadeUp { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }
  .animate-in { animation:fadeUp 0.5s ease forwards;opacity:0; }
  .delay-1{animation-delay:.05s}.delay-2{animation-delay:.1s}.delay-3{animation-delay:.15s}
  .delay-4{animation-delay:.2s}.delay-5{animation-delay:.25s}.delay-6{animation-delay:.3s}
  .delay-7{animation-delay:.35s}.delay-8{animation-delay:.4s}
  @media(max-width:900px) {
    .summary-bar{grid-template-columns:repeat(2,1fr)}
    .dashboard-grid{grid-template-columns:1fr}
    .main-content{padding:16px}
    .app-header{padding:16px;flex-wrap:wrap;gap:12px}
  }
</style>
</head>
<body>

<header class="app-header">
  <div class="logo-area">
    <div class="logo-icon">â›°</div>
    <div class="logo-text">
      <h1>Alpine Pulse</h1>
      <span>Sentiment Intelligence</span>
    </div>
  </div>
  <div class="header-meta">
    <span class="header-badge"><span class="live-dot" id="liveDot"></span> <span id="statusLabel">Loading...</span></span>
    <span class="date-display" id="currentDate"></span>
  </div>
</header>

<main class="main-content">
  <div class="data-status" id="dataStatus"></div>
  <div class="summary-bar" id="summaryBar"></div>
  <div class="resort-tabs" id="resortTabs"></div>
  <div class="dashboard-grid" id="row1"></div>
  <div class="dashboard-grid" id="row2"></div>
  <div class="dashboard-grid" id="row3"></div>
</main>

<script>
// =====================================================================
// ALPINE PULSE â€” LIVE DASHBOARD
// Reads from data/dashboard.json generated by collect.py
// Falls back to demo data if the file isn't available
// =====================================================================

const DATA_URL = './data/dashboard.json';
let currentResort = 'all';
let dashData = null;

// --- DEMO DATA (used when no live data available) ---
const DEMO = {
  generated_at: new Date().toISOString(),
  date: new Date().toISOString().split('T')[0],
  summary: { total_mentions: 347, positive_pct: 62, neutral_pct: 27, negative_pct: 11, negative_count: 38 },
  resort_stats: {
    fortress: { name:"Fortress Mountain", total:142, positive_pct:58, neutral_pct:28, negative_pct:14 },
    castle: { name:"Castle Mountain", total:118, positive_pct:70, neutral_pct:22, negative_pct:8 },
    nakiska: { name:"Nakiska", total:87, positive_pct:55, neutral_pct:32, negative_pct:13 }
  },
  themes: [
    {name:"Snow Conditions",mentions:89,avg_score:72,sentiment:"positive"},
    {name:"Pricing & Value",mentions:64,avg_score:48,sentiment:"neutral"},
    {name:"Summer Activities",mentions:52,avg_score:78,sentiment:"positive"},
    {name:"Staff & Service",mentions:41,avg_score:81,sentiment:"positive"},
    {name:"Lift Wait Times",mentions:38,avg_score:28,sentiment:"negative"},
    {name:"Facilities & Lodging",mentions:31,avg_score:52,sentiment:"neutral"},
    {name:"Trail Maintenance",mentions:18,avg_score:68,sentiment:"positive"},
    {name:"Environmental Impact",mentions:14,avg_score:45,sentiment:"neutral"}
  ],
  trends: {
    labels:['W1 Mon','','','','W1 Fri','W2 Mon','','','','W2 Fri','W3 Mon','','','','W3 Fri','W4 Mon','','','','Today'],
    positive:[55,58,54,60,57,59,61,58,63,60,58,62,59,64,61,63,60,65,63,62],
    neutral:[30,28,31,27,29,28,26,29,25,27,29,26,28,24,27,25,28,24,26,27],
    negative:[15,14,15,13,14,13,13,13,12,13,13,12,13,12,12,12,12,11,11,11]
  },
  theme_trends: {
    "Snow Conditions":[20,25,22,28,24,30,28,32,26,34,29,35,30,38,32,36,30,40,34,38],
    "Pricing & Value":[15,14,16,15,14,16,15,14,16,15,14,16,15,14,16,15,14,16,15,14],
    "Summer Activities":[5,6,5,7,6,8,7,9,8,10,9,12,11,14,13,16,15,18,17,20],
    "Staff & Service":[10,9,11,10,12,10,11,12,10,12,11,13,12,11,13,12,14,12,13,14]
  },
  feed: [
    {source:"X (Twitter)",resort:"fortress",sentiment:"positive",text:"Incredible powder day at Fortress! Fresh 25cm overnight and the alpine bowls are absolutely pristine. Best conditions this season. #FortressMountain",engagement:"47 likes",theme:"Snow Conditions",url:""},
    {source:"Reddit",resort:"castle",sentiment:"positive",text:"Castle Mountain is an underrated gem. No crowds, amazing terrain variety, and the new lodge upgrades are noticeable. Great value for a season pass.",engagement:"89 upvotes",theme:"Pricing & Value",url:""},
    {source:"Google Reviews",resort:"nakiska",sentiment:"negative",text:"Waited 35 minutes for the Olympic Chair on a Saturday. For a resort this close to Calgary, they need more lift capacity during peak weekends.",engagement:"3 stars",theme:"Lift Wait Times",url:""},
    {source:"Instagram",resort:"fortress",sentiment:"positive",text:"The backcountry access at Fortress is next level. Nothing else like it in Alberta. Already planning summer hiking trips too.",engagement:"234 likes",theme:"Summer Activities",url:""},
    {source:"CBC News",resort:"castle",sentiment:"neutral",text:"All Season Resorts Alberta announces expanded summer programming at Castle Mountain, including mountain biking trails and guided nature walks launching June 2026.",engagement:"News article",theme:"Summer Activities",url:""},
    {source:"Facebook",resort:"nakiska",sentiment:"positive",text:"Took the kids to Nakiska for their first ski lesson. Instructors were patient and amazing. Really well-organized family program!",engagement:"28 reactions",theme:"Staff & Service",url:""},
    {source:"X (Twitter)",resort:"fortress",sentiment:"negative",text:"Road to Fortress needs serious attention. Hit 3 potholes on the access road this morning. Love the skiing but the drive in is rough.",engagement:"23 likes",theme:"Access & Transportation",url:""},
    {source:"TripAdvisor",resort:"castle",sentiment:"positive",text:"Best ski experience in southern Alberta. The new grooming equipment has made a huge difference on the intermediate runs. Highly recommend.",engagement:"5 stars",theme:"Trail Maintenance",url:""},
    {source:"Reddit",resort:"nakiska",sentiment:"neutral",text:"Anyone know if Nakiska is planning to expand their summer operations? Would love to see mountain biking like what Castle is doing.",engagement:"12 comments",theme:"Summer Activities",url:""},
    {source:"Calgary Herald",resort:"fortress",sentiment:"positive",text:"Alberta's all-season resort strategy showing results as Fortress Mountain reports 18% visitor increase year-over-year for winter season.",engagement:"News article",theme:"Events & Promotions",url:""},
    {source:"Google Reviews",resort:"castle",sentiment:"negative",text:"Food options at the lodge are limited and overpriced. A burger and fries for $24 is too much. Would love to see more affordable options.",engagement:"2 stars",theme:"Facilities & Lodging",url:""},
    {source:"Instagram",resort:"nakiska",sentiment:"positive",text:"Night skiing at Nakiska hits different. Great vibes, well-lit runs, and the proximity to Calgary makes it perfect for after-work sessions.",engagement:"156 likes",theme:"Events & Promotions",url:""}
  ]
};

// --- LOAD DATA ---
async function loadData() {
  try {
    const res = await fetch(DATA_URL);
    if (!res.ok) throw new Error('No data file');
    dashData = await res.json();
    showStatus('live');
  } catch(e) {
    dashData = DEMO;
    showStatus('demo');
  }
  render();
}

function showStatus(mode) {
  const el = document.getElementById('dataStatus');
  const dot = document.getElementById('liveDot');
  const label = document.getElementById('statusLabel');
  if (mode === 'live') {
    el.className = 'data-status status-live';
    el.innerHTML = 'âœ“ Live data loaded â€” last collected: ' + new Date(dashData.generated_at).toLocaleString();
    dot.style.background = 'var(--positive)';
    label.textContent = 'Live Data';
  } else {
    el.className = 'data-status status-demo';
    el.innerHTML = 'âš¡ Demo mode â€” showing sample data. Run <code style="background:rgba(0,0,0,0.3);padding:2px 6px;border-radius:4px">python collect.py</code> to collect live data.';
    dot.style.background = 'var(--nakiska)';
    label.textContent = 'Demo Mode';
  }
}

// --- RENDER ---
function render() {
  const d = dashData;
  document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-CA',{weekday:'long',year:'numeric',month:'long',day:'numeric'});

  renderSummary(d);
  renderTabs();
  renderRow1(d);
  renderRow2(d);
  renderRow3(d);
}

function renderSummary(d) {
  const s = d.summary;
  document.getElementById('summaryBar').innerHTML = `
    <div class="summary-card animate-in delay-1">
      <div class="summary-label">Total Mentions</div>
      <div class="summary-value">${s.total_mentions}</div>
      <div class="summary-change change-up">ðŸ“Š Today's collection</div>
    </div>
    <div class="summary-card animate-in delay-2">
      <div class="summary-label">Positive Sentiment</div>
      <div class="summary-value" style="color:var(--positive)">${s.positive_pct}%</div>
      <div class="summary-change change-up">Overall score</div>
    </div>
    <div class="summary-card animate-in delay-3">
      <div class="summary-label">Negative Mentions</div>
      <div class="summary-value" style="color:var(--negative)">${s.negative_count}</div>
      <div class="summary-change">Requires attention</div>
    </div>
    <div class="summary-card animate-in delay-4">
      <div class="summary-label">Top Theme</div>
      <div class="summary-value" style="font-size:20px;margin-top:6px">${d.themes[0]?.name || 'â€”'}</div>
      <div class="summary-change">${d.themes[0]?.mentions || 0} mentions</div>
    </div>`;
}

function renderTabs() {
  const tabs = document.getElementById('resortTabs');
  tabs.innerHTML = `
    <button class="resort-tab active" data-resort="all">All Resorts</button>
    <button class="resort-tab" data-resort="fortress">â¬¥ Fortress</button>
    <button class="resort-tab" data-resort="castle">â¬¥ Castle Mountain</button>
    <button class="resort-tab" data-resort="nakiska">â¬¥ Nakiska</button>`;
  tabs.querySelectorAll('.resort-tab').forEach(t => {
    t.addEventListener('click', () => {
      tabs.querySelectorAll('.resort-tab').forEach(b => b.classList.remove('active'));
      t.classList.add('active');
      currentResort = t.dataset.resort;
      filterFeed();
    });
  });
}

function renderRow1(d) {
  const s = d.summary;
  // Resort bars
  let resortBars = '';
  for (const [rk,rs] of Object.entries(d.resort_stats)) {
    const color = rk==='fortress'?'var(--fortress)':rk==='castle'?'var(--castle)':'var(--nakiska)';
    resortBars += `
      <div class="resort-row">
        <div class="resort-row-header">
          <span class="resort-row-name" style="color:${color}">${rs.name}</span>
          <span class="resort-row-count">${rs.total} mentions</span>
        </div>
        <div class="sentiment-bar-container">
          <div class="sentiment-bar-pos" style="width:${rs.positive_pct}%"></div>
          <div class="sentiment-bar-neu" style="width:${rs.neutral_pct}%"></div>
          <div class="sentiment-bar-neg" style="width:${rs.negative_pct}%"></div>
        </div>
      </div>`;
  }

  // Theme rows
  let themeRows = d.themes.map(t => {
    const sc = t.sentiment==='positive'?'badge-pos':t.sentiment==='negative'?'badge-neg':'badge-neu';
    return `<tr>
      <td>${t.name}</td>
      <td>${t.mentions}</td>
      <td><span class="badge ${sc}">${t.sentiment.charAt(0).toUpperCase()+t.sentiment.slice(1)}</span></td>
      <td style="color:var(--text-muted)">${t.avg_score}/100</td>
    </tr>`;
  }).join('');

  document.getElementById('row1').innerHTML = `
    <div class="card animate-in delay-4">
      <div class="card-header"><span class="card-title">Sentiment Breakdown</span></div>
      <div class="sentiment-overview">
        <div class="sentiment-block"><div class="sentiment-pct pos">${s.positive_pct}%</div><div class="sentiment-label">Positive</div></div>
        <div class="sentiment-block"><div class="sentiment-pct neu">${s.neutral_pct}%</div><div class="sentiment-label">Neutral</div></div>
        <div class="sentiment-block"><div class="sentiment-pct neg">${s.negative_pct}%</div><div class="sentiment-label">Negative</div></div>
      </div>
      <div class="sentiment-bar-container" style="margin-top:20px">
        <div class="sentiment-bar-pos" style="width:${s.positive_pct}%"></div>
        <div class="sentiment-bar-neu" style="width:${s.neutral_pct}%"></div>
        <div class="sentiment-bar-neg" style="width:${s.negative_pct}%"></div>
      </div>
      <div class="resort-breakdown">${resortBars}</div>
    </div>
    <div class="card animate-in delay-5">
      <div class="card-header"><span class="card-title">Theme Rankings</span></div>
      <table class="theme-table">
        <thead><tr><th>Theme</th><th>Mentions</th><th>Sentiment</th><th>Score</th></tr></thead>
        <tbody>${themeRows}</tbody>
      </table>
    </div>`;
}

function renderRow2(d) {
  document.getElementById('row2').innerHTML = `
    <div class="card animate-in delay-6">
      <div class="card-header"><span class="card-title">Rolling Sentiment Trend</span><span class="card-subtitle">Past workdays</span></div>
      <div class="chart-container"><svg class="chart-svg" id="trendChart" viewBox="0 0 600 220" preserveAspectRatio="none"></svg></div>
      <div class="chart-legend">
        <div class="legend-item"><div class="legend-dot" style="background:var(--positive)"></div> Positive</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--neutral)"></div> Neutral</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--negative)"></div> Negative</div>
      </div>
    </div>
    <div class="card animate-in delay-7">
      <div class="card-header"><span class="card-title">Live Feed</span><span class="card-subtitle">Latest mentions</span></div>
      <div class="feed-list" id="feedList"></div>
    </div>`;

  drawChart('trendChart',[
    {data:d.trends.positive,color:'#34d399'},
    {data:d.trends.neutral,color:'#94a3b8'},
    {data:d.trends.negative,color:'#f87171'}
  ], d.trends.labels);

  renderFeed(d);
}

function renderRow3(d) {
  // Theme trend chart
  const themeColors = ['#38bdf8','#a78bfa','#fbbf24','#34d399','#f87171','#fb923c'];
  const themeKeys = Object.keys(d.theme_trends).slice(0,4);
  const datasets = themeKeys.map((k,i) => ({data:d.theme_trends[k],color:themeColors[i%themeColors.length]}));
  const legendHtml = themeKeys.map((k,i) => `<div class="legend-item"><div class="legend-dot" style="background:${themeColors[i]}"></div> ${k}</div>`).join('');

  // Generate action items from themes
  const negThemes = d.themes.filter(t => t.sentiment === 'negative');
  const neuThemes = d.themes.filter(t => t.sentiment === 'neutral').slice(0,1);
  const posThemes = d.themes.filter(t => t.sentiment === 'positive').slice(0,1);

  let actions = '';
  negThemes.forEach(t => {
    actions += `<div class="action-item"><div class="action-priority priority-high"></div><div class="action-text"><strong>${t.name}</strong> â€” ${t.mentions} mentions with negative sentiment (score: ${t.avg_score}/100). Review specific mentions and consider response strategy.</div></div>`;
  });
  neuThemes.forEach(t => {
    actions += `<div class="action-item"><div class="action-priority priority-med"></div><div class="action-text"><strong>${t.name}</strong> â€” ${t.mentions} mentions trending neutral. Monitor for shifts and consider proactive messaging.</div></div>`;
  });
  posThemes.forEach(t => {
    actions += `<div class="action-item"><div class="action-priority priority-low"></div><div class="action-text"><strong>${t.name}</strong> â€” Strong positive sentiment (${t.avg_score}/100, ${t.mentions} mentions). Amplify and share wins with team.</div></div>`;
  });

  document.getElementById('row3').innerHTML = `
    <div class="card animate-in delay-7">
      <div class="card-header"><span class="card-title">Theme Volume Trend</span></div>
      <div class="chart-container"><svg class="chart-svg" id="themeChart" viewBox="0 0 600 220" preserveAspectRatio="none"></svg></div>
      <div class="chart-legend">${legendHtml}</div>
    </div>
    <div class="card animate-in delay-8">
      <div class="card-header"><span class="card-title">Executive Action Items</span><span class="card-subtitle">Auto-generated from sentiment</span></div>
      <div class="action-list">${actions}</div>
    </div>`;

  if (datasets.length) {
    const maxLen = Math.max(...datasets.map(ds => ds.data.length));
    const labels = Array(maxLen).fill('');
    drawChart('themeChart', datasets, labels);
  }
}

function renderFeed(d) {
  const list = document.getElementById('feedList');
  list.innerHTML = d.feed.map(item => `
    <div class="feed-item" data-resort="${item.resort}" ${item.url ? `onclick="window.open('${item.url}','_blank')"` : ''}>
      <div class="feed-sentiment ${item.sentiment}"></div>
      <div class="feed-body">
        <div class="feed-source">
          ${item.source}
          <span class="feed-resort-tag tag-${item.resort}">${item.resort.toUpperCase()}</span>
          ${item.theme ? `<span style="color:var(--text-muted);font-size:9px">Â· ${item.theme}</span>` : ''}
        </div>
        <div class="feed-text">${item.text}</div>
        <div class="feed-meta">
          <span>${item.engagement || ''}</span>
        </div>
      </div>
    </div>
  `).join('');
}

function filterFeed() {
  document.querySelectorAll('.feed-item').forEach(item => {
    item.style.display = (currentResort === 'all' || item.dataset.resort === currentResort) ? '' : 'none';
  });
}

function drawChart(svgId, datasets, labels) {
  const svg = document.getElementById(svgId);
  if (!svg || !datasets.length) return;
  const W=600,H=220,pad={t:10,r:20,b:30,l:35};
  const cW=W-pad.l-pad.r, cH=H-pad.t-pad.b;
  let html='';
  const allVals = datasets.flatMap(ds => ds.data);
  const maxVal = Math.max(...allVals, 10);

  for(let i=0;i<=4;i++){
    const y=pad.t+(cH/4)*i;
    const val=Math.round(maxVal-(maxVal/4)*i);
    html+=`<line x1="${pad.l}" y1="${y}" x2="${W-pad.r}" y2="${y}" class="chart-grid-line"/>`;
    html+=`<text x="${pad.l-8}" y="${y+3}" text-anchor="end" class="chart-label">${val}</text>`;
  }
  labels.forEach((l,i)=>{
    if(l){const x=pad.l+(cW/(labels.length-1))*i;html+=`<text x="${x}" y="${H-5}" text-anchor="middle" class="chart-label">${l}</text>`;}
  });
  datasets.forEach(ds=>{
    const pts=ds.data.map((v,i)=>{
      const x=pad.l+(cW/(ds.data.length-1))*i;
      const y=pad.t+cH-(v/maxVal)*cH;
      return `${x},${y}`;
    });
    const fx=pad.l,lx=pad.l+cW,by=pad.t+cH;
    html+=`<polygon points="${pts.join(' ')} ${lx},${by} ${fx},${by}" fill="${ds.color}" class="chart-area"/>`;
    html+=`<polyline points="${pts.join(' ')}" class="chart-line" stroke="${ds.color}"/>`;
    const lp=pts[pts.length-1].split(',');
    html+=`<circle cx="${lp[0]}" cy="${lp[1]}" r="4" fill="${ds.color}" stroke="var(--bg-card)" stroke-width="2"/>`;
  });
  svg.innerHTML=html;
}

// Auto-refresh every 30 minutes
setInterval(loadData, 30*60*1000);

// Init
loadData();
</script>
</body>
</html>
